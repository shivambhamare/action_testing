name: Multi-scan compare with main

on:
  push:
    branches:
      - '**'     # run on all branches

jobs:
  scans:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scan_type: [code, container, dependency]

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4

      # 1) Run scan on CURRENT branch
      - name: Run ${{ matrix.scan_type }} scan on current branch
        run: |
          mkdir -p scans/${{ matrix.scan_type }}/current

          case "${{ matrix.scan_type }}" in
            code)
              # ðŸ” your code scan command
              echo "code scan result for ${{ github.ref_name }}" > scans/code/current/result.txt
              ;;
            container)
              # ðŸ” your container scan command
              echo "container scan result for ${{ github.ref_name }}" > scans/container/current/result.txt
              ;;
            dependency)
              # ðŸ” your dependency scan command
              echo "dependency scan result for ${{ github.ref_name }}" > scans/dependency/current/result.txt
              ;;
          esac

      # 2) On MAIN: upload baseline and STOP
      - name: Upload baseline artifact (only on main)
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_baseline
          path: scans/${{ matrix.scan_type }}/current/

      # === Everything below only runs on NON-main ===

      # 3) Checkout main branch in separate folder
      - name: Checkout main branch
        if: github.ref_name != 'main'
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-src

      # 4) Run same scan on MAIN
      - name: Run ${{ matrix.scan_type }} scan on main
        if: github.ref_name != 'main'
        run: |
          cd main-src
          mkdir -p scans/${{ matrix.scan_type }}/baseline

          case "${{ matrix.scan_type }}" in
            code)
              # ðŸ” same code scan, but for main
              echo "code scan result for main" > scans/code/baseline/result.txt
              ;;
            container)
              # ðŸ” same container scan, but for main
              echo "container scan result for main" > scans/container/baseline/result.txt
              ;;
            dependency)
              # ðŸ” same dependency scan, but for main
              echo "dependency scan result for main" > scans/dependency/baseline/result.txt
              ;;
          esac

      # 5) Compare current branch vs main for this scan type
      - name: Generate diff for ${{ matrix.scan_type }} scan
        if: github.ref_name != 'main'
        run: |
          mkdir -p scans/${{ matrix.scan_type }}/diff

          echo "=== Diff: main vs ${{ github.ref_name }} for ${{ matrix.scan_type }} scan ===" \
            > scans/${{ matrix.scan_type }}/diff/diff.txt
          echo "" >> scans/${{ matrix.scan_type }}/diff/diff.txt

          echo ">> main baseline files:"
          ls -R main-src/scans/${{ matrix.scan_type }}/baseline || echo "no main baseline"

          echo ">> current branch files:"
          ls -R scans/${{ matrix.scan_type }}/current || echo "no current files"

          # Simple textual diff â€“ replace with your own logic if needed
          diff -ru main-src/scans/${{ matrix.scan_type }}/baseline \
                  scans/${{ matrix.scan_type }}/current \
                  >> scans/${{ matrix.scan_type }}/diff/diff.txt || true

      # 6) Upload diff artifact
      - name: Upload diff artifact
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_diff
          path: scans/${{ matrix.scan_type }}/diff/diff.txt

      # 7) (optional) upload current branch scan result too
      - name: Upload current scan result
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_result
          path: scans/${{ matrix.scan_type }}/current/
