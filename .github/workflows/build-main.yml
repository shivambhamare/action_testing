name: Nightly baselines + branch scans

on:
  schedule:
    - cron: '*/3 * * * *'   # every 3 minutes (best effort)
  workflow_dispatch:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  nightly_baselines:
    # Run on schedule / manual / push but only when the ref is main
    if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scan_type: [code, container, dependency]

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Run ${{ matrix.scan_type }} scan on main (baseline)
        run: |
          set -euo pipefail
          mkdir -p scans/${{ matrix.scan_type }}/baseline

          case "${{ matrix.scan_type }}" in
            code)
              # replace with your real code scanner
              echo "BASELINE: code scan for main $(date)" > scans/code/baseline/result.txt
              ;;
            container)
              # replace with your real container scanner
              echo "BASELINE: container scan for main $(date)" > scans/container/baseline/result.txt
              ;;
            dependency)
              # replace with your real dependency scanner
              echo "BASELINE: dependency scan for main $(date)" > scans/dependency/baseline/result.txt
              ;;
          esac

      - name: Upload baseline artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_baseline
          path: scans/${{ matrix.scan_type }}/baseline/

  branch_scans:
    # Run for non-main branch pushes/PRs only
    if: github.event_name != 'schedule' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scan_type: [code, container, dependency]

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4

      - name: Run ${{ matrix.scan_type }} scan on current branch
        run: |
          set -euo pipefail
          mkdir -p scans/${{ matrix.scan_type }}/current

          case "${{ matrix.scan_type }}" in
            code)
              # replace with your real code scanner
              echo "CURRENT: code scan for ${{ github.ref_name }} $(date)" > scans/code/current/result.txt
              ;;
            container)
              # replace with your real container scanner
              echo "CURRENT: container scan for ${{ github.ref_name }} $(date)" > scans/container/current/result.txt
              ;;
            dependency)
              # replace with your real dependency scanner
              echo "CURRENT: dependency scan for ${{ github.ref_name }} $(date)" > scans/dependency/current/result.txt
              ;;
          esac

      - name: Get latest successful nightly run on main by workflow name
        id: get_baseline_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          WORKFLOW_DISPLAY_NAME="Nightly baselines + branch scans"   # must match the `name:` at top of this workflow

          echo "Repository: $REPO"
          echo "Looking for latest successful run on 'main' of workflow: $WORKFLOW_DISPLAY_NAME"

          # fetch recent runs on main (we ask up to 50 recent runs)
          response=$(gh api "repos/$REPO/actions/runs" --field branch=main --field status=success --field per_page=50 2>/dev/null || true)
          if [ -z "$response" ] || [ "$response" = "null" ]; then
            echo "No runs response from GitHub API"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find run id where .name equals the workflow display name
          run_id=$(echo "$response" | jq -r --arg NAME "$WORKFLOW_DISPLAY_NAME" '.workflow_runs[] | select(.name == $NAME) | .id' | head -n1 || true)

          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "No successful workflow run named '$WORKFLOW_DISPLAY_NAME' found on main"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
          else
            echo "Found baseline run id: $run_id"
            echo "has_baseline=true" >> $GITHUB_OUTPUT
            echo "run_id=$run_id" >> $GITHUB_OUTPUT
          fi

      - name: Download nightly baseline artifact (if exists)
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.get_baseline_run.outputs.run_id }}"
          ARTIFACT_NAME="${{ matrix.scan_type }}_scan_baseline"

          echo "Looking for artifact named '$ARTIFACT_NAME' in run $RUN_ID"

          # List artifacts and find matching id
          artifact_id=$(gh api "repos/$REPO/actions/runs/$RUN_ID/artifacts" --jq ".artifacts[] | select(.name==\"${ARTIFACT_NAME}\") | .id // empty" 2>/dev/null || true)

          if [ -z "$artifact_id" ]; then
            echo "No artifact named $ARTIFACT_NAME found in run $RUN_ID"
            exit 0
          fi

          echo "Found artifact id: $artifact_id"
          mkdir -p scans/${{ matrix.scan_type }}/baseline
          gh api "repos/$REPO/actions/artifacts/$artifact_id/zip" -o baseline.zip
          unzip -q baseline.zip -d scans/${{ matrix.scan_type }}/baseline
          echo "Baseline extracted to scans/${{ matrix.scan_type }}/baseline"

      - name: Generate diff for ${{ matrix.scan_type }} scan (only if baseline exists)
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        run: |
          set -euo pipefail
          mkdir -p scans/${{ matrix.scan_type }}/diff
          DIFF_FILE="scans/${{ matrix.scan_type }}/diff/diff.txt"

          echo "=== Diff: nightly main baseline vs ${{ github.ref_name }} for ${{ matrix.scan_type }} scan ===" > "$DIFF_FILE"
          echo "" >> "$DIFF_FILE"

          echo ">> Baseline files:" >> "$DIFF_FILE"
          ls -R scans/${{ matrix.scan_type }}/baseline >> "$DIFF_FILE" 2>&1 || echo "no baseline files" >> "$DIFF_FILE"

          echo "" >> "$DIFF_FILE"
          echo ">> Current branch files:" >> "$DIFF_FILE"
          ls -R scans/${{ matrix.scan_type }}/current >> "$DIFF_FILE" 2>&1 || echo "no current files" >> "$DIFF_FILE"

          echo "" >> "$DIFF_FILE"
          echo ">> Unified diff:" >> "$DIFF_FILE"

          diff -ru scans/${{ matrix.scan_type }}/baseline scans/${{ matrix.scan_type }}/current >> "$DIFF_FILE" || true

      - name: Upload diff artifact (only if baseline exists)
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_diff
          path: scans/${{ matrix.scan_type }}/diff/diff.txt

      - name: Upload current scan result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_result
          path: scans/${{ matrix.scan_type }}/current/
