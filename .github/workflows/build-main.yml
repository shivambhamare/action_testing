name: Nightly baselines + branch scans

on:
  # Nightly job to refresh baselines on main
  schedule:
    - cron: '*/3 * * * *'   # every 3 minutes

  # Manual trigger if you want to force-refresh baselines
  workflow_dispatch:

  # Branch scans (dev, feature, etc.)
  push:
    branches:
      - '**'                    # all branches
  pull_request:
    branches:
      - '**'

jobs:
  # ===========================================
  # 1) NIGHTLY BASELINES (main branch only)
  # ===========================================
  nightly_baselines:
    # Run only for schedule or manual on main
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main')
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scan_type: [code, container, dependency]

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      # Run scan on MAIN and store as baseline
      - name: Run ${{ matrix.scan_type }} scan on main
        run: |
          mkdir -p scans/${{ matrix.scan_type }}/baseline

          case "${{ matrix.scan_type }}" in
            code)
              # 游대 YOUR REAL CODE SCAN COMMAND HERE
              # Example:
              # semgrep --config=p/ci --json > scans/code/baseline/result.json
              echo "code scan result for main $(date)" > scans/code/baseline/result.txt
              ;;
            container)
              # 游대 YOUR REAL CONTAINER SCAN COMMAND HERE
              # Example:
              # trivy image --format json -o scans/container/baseline/result.json your-image:tag
              echo "container scan result for main $(date)" > scans/container/baseline/result.txt
              ;;
            dependency)
              # 游대 YOUR REAL DEPENDENCY SCAN COMMAND HERE
              # Example:
              # osv-scanner --json > scans/dependency/baseline/result.json
              echo "dependency scan result for main $(date)" > scans/dependency/baseline/result.txt
              ;;
          esac

      # Upload baseline artifact (one per scan type)
      - name: Upload baseline artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_baseline
          path: scans/${{ matrix.scan_type }}/baseline/

  # ===========================================
  # 2) BRANCH SCANS (dev/feature/etc) USING NIGHTLY BASELINES
  # ===========================================
  branch_scans:
    # Do NOT run this job for nightly (schedule). Only for push/PR/workflow_dispatch.
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scan_type: [code, container, dependency]

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4

      # 1) Run scan on CURRENT BRANCH
      - name: Run ${{ matrix.scan_type }} scan on current branch
        run: |
          mkdir -p scans/${{ matrix.scan_type }}/current

          case "${{ matrix.scan_type }}" in
            code)
              # 游대 YOUR REAL CODE SCAN COMMAND HERE
              echo "code scan result for ${{ github.ref_name }} $(date)" > scans/code/current/result.txt
              ;;
            container)
              # 游대 YOUR REAL CONTAINER SCAN COMMAND HERE
              echo "container scan result for ${{ github.ref_name }} $(date)" > scans/container/current/result.txt
              ;;
            dependency)
              # 游대 YOUR REAL DEPENDENCY SCAN COMMAND HERE
              echo "dependency scan result for ${{ github.ref_name }} $(date)" > scans/dependency/current/result.txt
              ;;
          esac

      # 2) Get latest SUCCESSFUL run of THIS workflow on main
      - name: Get latest nightly baseline run on main
        id: get_baseline_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          WORKFLOW_FILE="build-main.yml"   # 游녣 MUST MATCH THIS FILE'S NAME

          echo "Looking for latest successful $WORKFLOW_FILE on main in $REPO"

          set +e
          response=$(gh api "repos/$REPO/actions/workflows/$WORKFLOW_FILE/runs" \
            --field branch=main --field status=success --field per_page=1 2>&1)
          status=$?
          set -e

          if [ $status -ne 0 ]; then
            echo "Failed to query workflow runs:"
            echo "$response"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          run_id=$(echo "$response" | jq -r '.workflow_runs[0].id // empty')

          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "No successful nightly baseline run found on main. Skipping compare."
            echo "has_baseline=false" >> $GITHUB_OUTPUT
          else
            echo "Latest baseline run id: $run_id"
            echo "has_baseline=true" >> $GITHUB_OUTPUT
            echo "run_id=$run_id" >> $GITHUB_OUTPUT
          fi

      # 3) Download the correct baseline artifact for THIS scan_type
      - name: Download nightly baseline artifact
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          RUN_ID="${{ steps.get_baseline_run.outputs.run_id }}"
          ARTIFACT_NAME="${{ matrix.scan_type }}_scan_baseline"

          echo "Looking for artifact $ARTIFACT_NAME in run $RUN_ID"

          set +e
          artifact_id=$(gh api "repos/$REPO/actions/runs/$RUN_ID/artifacts" \
            --jq ".artifacts[] | select(.name==\"${ARTIFACT_NAME}\") | .id // empty" 2>&1)
          status=$?
          set -e

          if [ $status -ne 0 ] || [ -z "$artifact_id" ]; then
            echo "No artifact named ${ARTIFACT_NAME} found in baseline run. Skipping compare."
            exit 0
          fi

          echo "Found artifact id: $artifact_id"

          mkdir -p scans/${{ matrix.scan_type }}/baseline
          gh api "repos/$REPO/actions/artifacts/$artifact_id/zip" -o baseline.zip
          unzip baseline.zip -d scans/${{ matrix.scan_type }}/baseline

      # 4) Compare nightly baseline vs current scan
      - name: Generate diff for ${{ matrix.scan_type }} scan
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        run: |
          mkdir -p scans/${{ matrix.scan_type }}/diff

          DIFF_FILE="scans/${{ matrix.scan_type }}/diff/diff.txt"

          echo "=== Diff: nightly main baseline vs ${{ github.ref_name }} for ${{ matrix.scan_type }} scan ===" > "$DIFF_FILE"
          echo "" >> "$DIFF_FILE"

          echo ">> Baseline files:" >> "$DIFF_FILE"
          ls -R scans/${{ matrix.scan_type }}/baseline >> "$DIFF_FILE" 2>&1 || echo "no baseline files" >> "$DIFF_FILE"

          echo "" >> "$DIFF_FILE"
          echo ">> Current branch files:" >> "$DIFF_FILE"
          ls -R scans/${{ matrix.scan_type }}/current >> "$DIFF_FILE" 2>&1 || echo "no current files" >> "$DIFF_FILE"

          echo "" >> "$DIFF_FILE"
          echo ">> Unified diff:" >> "$DIFF_FILE"

          diff -ru scans/${{ matrix.scan_type }}/baseline \
                  scans/${{ matrix.scan_type }}/current \
                  >> "$DIFF_FILE" || true

      # 5) Upload diff artifact
      - name: Upload diff artifact
        if: steps.get_baseline_run.outputs.has_baseline == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_diff
          path: scans/${{ matrix.scan_type }}/diff/diff.txt

      # 6) Optional: upload current scan result
      - name: Upload current scan result
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.scan_type }}_scan_result
          path: scans/${{ matrix.scan_type }}/current/



