name: Build & compare with main

# required so GITHUB_TOKEN can read actions & artifacts
permissions:
  contents: read
  actions: read

on:
  push:
    branches:
      - main
      - dev
      - '**'    # keep if you want builds on other branches
  pull_request:
    branches:
      - '**'

env:
  # Edit these two values to match your repo's nightly baseline workflow and artifact name
  NIGHTLY_WORKFLOW_DISPLAY_NAME: "Nightly baselines + branch scans"
  BASELINE_ARTIFACT_NAME: "main-artifact"

jobs:
  build-and-compare:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the current branch (main / dev / feature / etc.)
      - name: Checkout current branch
        uses: actions/checkout@v4

      # 2) Build artifact for the CURRENT branch
      - name: Build artifact for current branch
        run: |
          mkdir -p build-output
          # ðŸ” Replace this with your real build commands
          echo "${{ github.ref_name }} build $(date)" > build-output/app.txt

      # 3) If this is MAIN: just upload the artifact (no compare)
      - name: Upload main artifact (only on main)
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: main-artifact
          path: build-output/

      # =========================================================
      # 4) For NON-main branches: try to download baseline artifact
      # =========================================================
      - name: Try download baseline artifact from latest successful nightly run on main
        if: github.ref_name != 'main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_NAME: ${{ env.NIGHTLY_WORKFLOW_DISPLAY_NAME }}
          BASELINE_ARTIFACT_NAME: ${{ env.BASELINE_ARTIFACT_NAME }}
        run: |
          set -euo pipefail
          echo "Repo: $REPO"
          echo "Looking for latest successful run on main of workflow: '$WORKFLOW_NAME'"

          # Query recent successful runs on main (first 50)
          API="https://api.github.com/repos/$REPO/actions/runs?branch=main&status=success&per_page=50"
          raw=$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
                         -H "Accept: application/vnd.github+json" \
                         "$API" || true)

          echo "API call result (snippet):"
          echo "$raw" | sed -n '1,200p' || true

          # if API returned a message field -> likely error/permission
          if echo "$raw" | jq -e '.message? // empty' >/dev/null 2>&1; then
            echo "API error or message returned - cannot find baseline runs. Skipping baseline download."
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # show the names found (debug)
          echo "Available run names (from returned workflow_runs):"
          echo "$raw" | jq -r '.workflow_runs[]?.name' | sed -n '1,200p' || true

          # Find the first run whose .name equals the desired workflow display name
          run_id=$(echo "$raw" | jq -r --arg NAME "$WORKFLOW_NAME" '.workflow_runs[] | select(.name == $NAME) | .id' | head -n1 || true)

          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "No successful workflow run named '$WORKFLOW_NAME' found on main (in the last 50 runs)."
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found baseline run id: $run_id. Looking for artifact named: $BASELINE_ARTIFACT_NAME"

          # List artifacts for the run and find the artifact id
          arts_raw=$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
                             -H "Accept: application/vnd.github+json" \
                             "https://api.github.com/repos/$REPO/actions/runs/$run_id/artifacts" || true)

          artifact_id=$(echo "$arts_raw" | jq -r --arg A "$BASELINE_ARTIFACT_NAME" '.artifacts[] | select(.name == $A) | .id // empty' || true)

          if [ -z "$artifact_id" ]; then
            echo "No artifact named '$BASELINE_ARTIFACT_NAME' found in run $run_id."
            echo "has_baseline=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found artifact id: $artifact_id. Downloading..."
          # download artifact zip
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/$REPO/actions/artifacts/$artifact_id/zip" -o baseline.zip

          mkdir -p baseline/build-output
          unzip -q baseline.zip -d baseline
          # Many uploaded zips contain a top-level folder; find build-output inside baseline
          # If the artifact contained build-output/ directly, it will now appear under baseline/
          echo "Contents after unzip:"
          find baseline -maxdepth 3 -type f -print || true

          # normalization: move any build-output/ subtree to baseline/build-output
          # If unzip created baseline/build-output/ already, this will be harmless
          if [ -d "baseline/build-output" ]; then
            echo "baseline/build-output exists"
          else
            # try to locate any build-output directory in the unzipped tree
            found=$(find baseline -type d -name 'build-output' -print -quit || true)
            if [ -n "$found" ]; then
              echo "Found nested build-output at: $found â€” moving to baseline/build-output"
              mkdir -p baseline
              mv "$found" baseline/build-output
            else
              echo "No build-output directory found inside artifact â€” listing baseline/*"
              ls -la baseline || true
            fi
          fi

          # At this point we expect baseline/build-output/ to exist
          if [ -d "baseline/build-output" ]; then
            echo "Baseline extracted to baseline/build-output"
            echo "has_baseline=true" >> $GITHUB_OUTPUT
          else
            echo "Baseline not present after extraction"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
          fi

      # Optional fallback: if baseline is missing, checkout main and build it locally
      # Uncomment the following steps if you want fallback behavior
      - name: Fallback - Checkout main and build (only if baseline missing)
        if: github.ref_name != 'main' && steps.Try_download_baseline_artifact_from_latest_successful_nightly_run_on_main.outputs.has_baseline == 'false'
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-src

      - name: Fallback - Build main (only if baseline missing)
        if: github.ref_name != 'main' && steps.Try_download_baseline_artifact_from_latest_successful_nightly_run_on_main.outputs.has_baseline == 'false'
        run: |
          cd main-src
          mkdir -p build-output
          echo "main build (fallback) $(date)" > build-output/app.txt
          # If you used fallback, set baseline from built main
          mkdir -p ../baseline/build-output
          mv build-output/* ../baseline/build-output/ || true

      # =========================================================
      # 5) For NON-main branches: compare MAIN baseline vs CURRENT branch artifact
      # =========================================================
      - name: Generate diff-with-main.txt
        if: github.ref_name != 'main' && (steps.Try_download_baseline_artifact_from_latest_successful_nightly_run_on_main.outputs.has_baseline == 'true' || always() )
        run: |
          mkdir -p diff-output
          echo "=== Diff: baseline/main vs ${{ github.ref_name }} ===" > diff-output/diff-with-main.txt
          echo "" >> diff-output/diff-with-main.txt

          echo ">> listing baseline build-output"
          ls -R baseline/build-output || echo "no baseline build-output"
          echo "" >> diff-output/diff-with-main.txt

          echo ">> listing current branch build-output"
          ls -R build-output || echo "no current build-output"
          echo "" >> diff-output/diff-with-main.txt

          # Only run diff if baseline exists
          if [ -d "baseline/build-output" ]; then
            diff -ru baseline/build-output build-output >> diff-output/diff-with-main.txt || true
          else
            echo "No baseline available to diff against." >> diff-output/diff-with-main.txt
          fi

      # 6) Upload diff artifact (only for non-main branches)
      - name: Upload diff-with-main artifact
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: diff-with-main
          path: diff-output/diff-with-main.txt

      # 7) (Optional) upload artifact for non-main branches too
      - name: Upload branch artifact (non-main)
        if: github.ref_name != 'main'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.ref_name }}-artifact
          path: build-output/
